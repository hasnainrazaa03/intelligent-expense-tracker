generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  email     String     @unique
  password  String
  isVerified      Boolean   @default(false)
  verificationOtp String?
  otpExpires      DateTime?
  expenses  Expense[]
  incomes   Income[]
  budgets   Budget[]
  semesters Semester[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model Expense {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  amount           Float
  category         String
  date             DateTime @db.Date
  paymentMethod    String?
  notes            String?
  originalAmount   Float?
  originalCurrency String?
  isRecurring      Boolean? @default(false)
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String   @db.ObjectId
}

model Income {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  title            String
  amount           Float
  category         String
  date             DateTime @db.Date
  notes            String?
  originalAmount   Float?
  originalCurrency String?
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String   @db.ObjectId
}

model Budget {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  category String
  amount   Float
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId   String @db.ObjectId

  @@unique([userId, category])
}

model Semester {
  // MongoDB MUST have a single _id primary key
  id_internal  String @id @default(auto()) @map("_id") @db.ObjectId
  
  id           String // This is your 'fall-2025' string
  name         String
  totalTuition Float
  user         User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String @db.ObjectId
  installments TuitionInstallment[]

  // Use @@unique instead of @@id for composite uniqueness in MongoDB
  @@unique([id, userId]) 
}

model TuitionInstallment {
  // autoincrement() is not supported in MongoDB
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  amount         Float
  status         String
  expenseId      String?
  paidDate       DateTime? @db.Date
  
  // Relating to Semester's custom unique constraint
  semester       Semester  @relation(fields: [semesterId, semesterUserId], references: [id, userId], onDelete: Cascade)
  semesterId     String
  semesterUserId String    @db.ObjectId
}